---
title: "MSF country EpiSitrep on Covid-19 epidemic"
description: |
  This document presents tables, graphs and maps of the MSF Covid-19 linelists analyses for a single country (not much text). Most, but not all, of these analyses are presented and commented in the MSF Intersection Covid-19 EpiSitrep edited by Epicentre (for information on the EpiSitrep, please contact Anais.BROBAN@epicentre.msf.org).    
  
  The R scripts for both worldwide and MSF linelist analyses are provided on the following Github repository https://github.com/epicentre-msf/covid19-episitrep-country for epidemiologists in MSF to use (R skills required). The scripts will be updated from week to week as analysis progresses as requested. 
author:
  - name: Francesco Grandesso
    url: mailto:francesco.GRANDESSO@epicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
  - name: Paul Campbell
    url: mailto:paul.CAMPBELLepicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
date: '`r Sys.Date()`'
output:
  distill::distill_article:
    toc: TRUE
    toc_depth: 1
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.cap = TRUE,
                      fig.width = 6,
                      fig.height = 4
                      )

# Set environment
source(here::here('R', 'setup.r'), encoding = 'UTF-8')

source(file.path(path.R, "utils_get_data.R")  , encoding = "UTF-8")
source(file.path(path.R, "utils_management.R"), encoding = "UTF-8")
source(file.path(path.R, "utils_vis.R")       , encoding = "UTF-8")
source(file.path(path.R, "utils_epicurve.R")  , encoding = "UTF-8")
source(file.path(path.R, "utils_modelling.R") , encoding = "UTF-8")
source(file.path(path.R, "set_time_frame.R") , encoding = "UTF-8")
```


```{r select-country, include=FALSE}

# Get list of countries (with pop)
df_countries <- get_countries_list()

iso_country <- 'AFG'

name_country <- df_countries %>% 
  filter(iso_a3 == iso_country) %>% 
  pull(country)

include_status <- c("Confirmed", "Probable", "Suspected")

# Default folder structure for country and week
source(file.path(path.R, "set_time_frame.R")  , encoding = "UTF-8")

```


```{r import-data, include=FALSE}

# Get geo data
sf_world <- get_world_sf(scale = 'small', proj = 'robinson', update_data = TRUE)

# TO PAUL We need to add country shapefiles


# Get ECDC data
dta_ecdc <- get_ecdc_data() %>% 
  prepare_ecdc_dta() %>% 
  filter(iso_a3 == iso_country)

# Get MSF data
path_latest_linelist <- max(list.files(file.path(path.sharepoint, "data/linelist/world"), pattern = "[.]rds$", full.names = TRUE))
dta_msf_linelist <- get_msf_country_linelist(path = path_latest_linelist, iso_country = iso_country)

path_agg_data <- file.path(path.sharepoint, "coordination", "Surveillance focal points coordination", "Aggregated reporting", "Report_covid_aggregate_all_v2.xlsx")
dta_msf_aggregated <- get_msf_country_aggregated(path_agg_data, iso_country = iso_country)

dta_msf_combined <- get_msf_combined_data(dta_msf_linelist, dta_msf_aggregated)

get_facet_dims <- function(df, facet_col = "site_name") {
  n <- dplyr::n_distinct(df[[facet_col]])
  ncol <- ifelse(n == 1, 1, 2)
  nrow <- ceiling(n / 2)
  height <- nrow * 3
  return(list(ncol = ncol, nrow = nrow, height = height))
}

```


# Data sources and definitions

This report uses the following data sources: 

  - [ECDC data](https://opendata.ecdc.europa.eu/covid19/casedistribution/csv) last updated `r format(max(dta_ecdc$date, na.rm = TRUE), "%d %b %Y")`.
  -	MSF linelists compiled by Epicentre
  -	MSF [GIS Unit](https://mapcentre.msf.org/) (baseline country maps)
  -	FIND [Diagnostics Resource Centre Unit](https://www.finddx.org/covid-19/) for data on Covid-19 tests

Definitions of increasing, declining and stable trends and the definition of doubling time, as well as detailed information on the analysis methods, can be found [here](https://msfintl-my.sharepoint.com/:u:/g/personal/francesco_grandesso_epicentre_msf_org/EZqExKcP8axMj06voaLlveABpiicCfzkk5OWB-EaJvo9Fw?e=lwU1eM).

Additional graphics and tables are also available at the [Epicentre COVID-19 Epi Dashboard](https://reports.msf.net/public/covid19/).

**IMPORTANT NOTE:** Data and results presented here are possibly affected by bias related with factors such as the testing strategies used by each country and the performance of their surveillance systems. Results are to be interpreted in the light of this information.

---



<!-- 
=== === === === === === === === === === === === === === === === === === === 
From this point all pairs of chunks are to be independent from each others
=== === === === === === === === === === === === === === === === === === === 
-->



# Epidemiological situation in `r name_country` 

## Evolution in cases and trends (external data)

<!-- Figure 1 - Epidemiological curves in cases and death -->
```{r plot-epicurve, fig.width=18*cm_to_in, fig.cap=paste('Covid-19 cases and deaths and trend estimations in', name_country), dpi=300}

# Priority +++
# by Francesco

# Six-plots graphs displaying: 

# 1. Epidemiological curve in daily cases (above) and deaths (below) since the first case was reported in the country
# 2. Cases (above) and deaths (below) in the last 30 days, with associated trend and confidence interval
# 3. Cases (above) and deaths (below) in the last 12 days, with associated trend and confidence interval

mdl_trend_cases_30d <- linear_model_cnt(dta_ecdc, series = 'cases', time_window = 30, last_date = date_max_report)
mdl_trend_cases_12d <- linear_model_cnt(dta_ecdc, series = 'cases', time_window = 12, last_date = date_max_report)
mdl_trend_deaths_30d <- linear_model_cnt(dta_ecdc, series = 'deaths', time_window = 30, last_date = date_max_report)
mdl_trend_deaths_12d <- linear_model_cnt(dta_ecdc, series = 'deaths', time_window = 12, last_date = date_max_report)

multiplot_counts_trends <- country_six_plots(dta = dta_ecdc, 
                                             mdl1_cases = mdl_trend_cases_30d, 
                                             mdl2_cases = mdl_trend_cases_12d, 
                                             mdl1_deaths = mdl_trend_deaths_30d, 
                                             mdl2_deaths = mdl_trend_deaths_12d)


ggsave(file.path(path.local.country.week.graphs, paste0('multiplot_counts_trends', '_', name_country, "_", week_report, '.png')), 
       plot = multiplot_counts_trends, 
       scale = 1, 
       dpi = 320)



multiplot_counts_trends + plot_annotation(title = "")

``` 

<!-- Table 1 - Summary of the epidemic situation in the country -->
```{r table-summary-country}
# Priority +++
# by Francesco

# Table displaying: 

# - cumulative case and deaths counts (since the beginning and in the last 12 days), 
# - cumulative incidence in cases and deaths per 100,000 population, 
# - naïve Case Fatality Risk, 
# - trend in cases and deaths and associated confidence intervals]. 

# Multiplying factors
pop_tot = dta_ecdc %>% distinct(population_2019) %>% pull()
inc_factor <- 100000

# Tables cases and deaths and cumulative incidence
tbl_tot <- dta_ecdc %>% 
  summarise(
    cases = sum(cases, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE),
    cases_inc = cases/pop_tot  * inc_factor, 
    deaths_inc = deaths/pop_tot * inc_factor) %>% 
  mutate(period = 'Total')

tbl_30days <- dta_ecdc %>% 
  filter(between(date, left = date_max_report - 29, right = date_max_report)) %>% 
  summarise(
    cases = sum(cases, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE),
    cases_inc = cases/(pop_tot - tbl_tot$cases + cases) * inc_factor, 
    deaths_inc = deaths/(pop_tot - tbl_tot$deaths + deaths) * inc_factor) %>% 
  mutate(period = 'Last 30 days')

tbl_12days <- dta_ecdc %>% 
  filter(between(date, left = date_max_report - 11, right = date_max_report)) %>% 
  summarise(
    cases = sum(cases, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE),
    cases_inc = cases/(pop_tot - tbl_tot$cases + cases) * inc_factor, 
    deaths_inc = deaths/(pop_tot - tbl_tot$deaths + deaths) * inc_factor) %>% 
  mutate(period = 'Last 12 days')

# Table doubling time
doubling_cases_30d <- doubling_time(mdl_trend_cases_30d$coeffs) %>% 
  rename_all(~paste(., 'cases', sep = '_'))

doubling_cases_12d <- doubling_time(mdl_trend_cases_12d$coeffs) %>% 
  rename_all(~paste(., 'cases', sep = '_'))

doubling_deaths_30d <- doubling_time(mdl_trend_deaths_30d$coeffs) %>% 
  rename_all(~paste(., 'deaths', sep = '_'))

doubling_deaths_12d <- doubling_time(mdl_trend_deaths_12d$coeffs) %>% 
  rename_all(~paste(., 'deaths', sep = '_'))

doubling_30d <- cbind(doubling_cases_30d, doubling_deaths_30d) %>% 
  mutate(
    period = 'Last 30 days', 
    ci_cases = combine_ci(lwr_cases, upr_cases), 
    ci_deaths = combine_ci(lwr_deaths, upr_deaths)) %>% 
  select(period, est_cases, ci_cases, est_deaths, ci_deaths)

doubling_12d <- cbind(doubling_cases_12d, doubling_deaths_12d) %>% 
  mutate(
    period = 'Last 12 days', 
    ci_cases = combine_ci(lwr_cases, upr_cases), 
    ci_deaths = combine_ci(lwr_deaths, upr_deaths)) %>% 
  select(period, est_cases, ci_cases, est_deaths, ci_deaths)

doubling <- rbind(doubling_30d, doubling_12d)

# Compose the final table
tbl_summary_country <- rbind(tbl_tot, tbl_30days, tbl_12days) %>% 
  mutate(cfr = deaths / cases * 100) %>% 
  left_join(doubling) %>% 
  select(period, cases, deaths, cfr, cases_inc, deaths_inc, est_cases, ci_cases, est_deaths, ci_deaths)


# gt table
gtbl_summary_country <- tbl_summary_country %>% 
  gt() %>% 
  cols_label(
    period = 'Period', 
    cases  = 'Cases', 
    deaths = 'Deaths', 
    cfr = 'naive CFR', 
    cases_inc = 'Cases', 
    deaths_inc = 'Deaths', 
    est_cases = 'Rate', 
    ci_cases  = '[95% CI]', 
    est_deaths = 'Rate', 
    ci_deaths = '[95% CI]') %>% 
  tab_spanner(
    label = 'Count', 
    columns = vars(cases, deaths)) %>% 
  tab_spanner(
    label = html(paste('Cumulative incidence<br> per', format(inc_factor, scientific = FALSE, big.mark = ','), 'pop')), 
    columns = vars(cases_inc, deaths_inc)) %>% 
  tab_spanner(
    label = html('Doubling time<br>in cases'), 
    columns = vars(est_cases, ci_cases)) %>% 
  tab_spanner(
    label = html('Doubling time<br>in deaths'), 
    columns = vars(est_deaths, ci_deaths)) %>% 
  fmt_number(
    columns = vars(cases, cases_inc, deaths, deaths_inc), 
    decimals = 0) %>% 
  fmt_number(
    columns = vars(cfr, est_cases, est_deaths), 
    decimals = 1) %>% 
  fmt_missing(
    columns = vars(est_cases, ci_cases, est_deaths, ci_deaths), 
    rows = 1, 
    missing_text = '') %>% 
  fmt_missing(
    columns = vars(est_cases, ci_cases, est_deaths, ci_deaths), 
    rows = c(2:3), 
    missing_text = '---') %>% 
   tab_options(
    column_labels.font.weight = "bold", 
    data_row.padding = px(1))

gtsave(gtbl_summary_country, 
       file.path(path.local.country.week.tables, paste0('gtbl_summary_country', '_', name_country, "_", week_report, '.png'))) %>%
  invisible()


gtbl_summary_country %>% 
  tab_header(
    title = paste('Summary cases and deaths and evolution of the epidemic in', name_country, 'in the last 30 and 12 days'))

```


## Country situation in surveillance, social measures and testing (external data)

```{r, include=FALSE}
# Priority ++
# To be assigned

# Table of the number of tests

```



# Analysis at MSF level

<!-- A note of what this report section is about and other useful links -->
This section of the report analyses data reported by MSF in the reporting system created by Epicentre and distributed to MSF projects. Data can also be visualized and explored in the Epicentre Linelist Dashboard (see information besides).


## Overview of reported data

### Projects reporting data

<!-- Table 2 – Projects reporting and associated numbers -->
```{r table-summary-site, layout = "l-body-outset"}
# Priority +++
# by Francesco

# Table with list of projects by country with counts by Covid status (confirmed, probable, suspected, not a case and unknown) and dates of first and last consultation/hospitalisation Projects reporting aggregated data are included in the table.


tbl_site_covid_status <- dta_msf_combined %>%
  select(-c(continent, country, country_lab)) %>%
  group_by(site_name) %>%
  summarise(
    total         = sum(Total, na.rm = TRUE), 
    confirmed_n   = sum(Confirmed, na.rm = TRUE),
    probable_n    = sum(Probable, na.rm = TRUE),
    suspected_n   = sum(Suspected, na.rm = TRUE),
    not_case_n    = sum(`Not a case`, na.rm = TRUE), 
    not_suspect_n = sum(`Not a suspect`, na.rm = TRUE), 
    unknown_n     = sum(Unknown, na.rm = TRUE)) %>% 
  adorn_totals() %>% 
  mutate(
    confirmed_p   = confirmed_n   / total,
    probable_p    = probable_n    / total,
    suspected_p   = suspected_n   / total,
    not_case_p    = not_case_n    / total, 
    not_suspect_p = not_suspect_n / total,
    unknown_p     = unknown_n     / total) %>%
  ungroup() %>%
  arrange(site_name)


tbl_site_dates <- dta_msf_combined %>%
  group_by(site_name) %>%
  summarise(
    date_adm_first = format(min(date, na.rm = TRUE), '%d-%m-%Y'),
    date_adm_last  = format(max(date, na.rm = TRUE), '%d-%m-%Y')) %>% 
  add_row(site_name = 'Total', dta_msf_combined %>% 
            summarise(
              date_adm_first = format(min(date, na.rm = TRUE), '%d-%m-%Y'), 
              date_adm_last  = format(max(date, na.rm = TRUE), '%d-%m-%Y')))


gtbl_site_covid_status <- tbl_site_covid_status %>%
  left_join(tbl_site_dates) %>%
  gt() %>%
  cols_label(
    site_name     = 'Site/Project',
    total         = 'Total',
    confirmed_n   = 'n',
    probable_n    = 'n',
    suspected_n   = 'n',
    not_case_n    = 'n',
    not_suspect_n = 'n',
    unknown_n     = 'n',
    confirmed_p   = '(%)',
    probable_p    = '(%)',
    suspected_p   = '(%)',
    not_case_p    = '(%)',
    not_suspect_p = '(%)',
    unknown_p     = '(%)',
    date_adm_first = 'First',
    date_adm_last  = 'Last') %>%
  tab_spanner(
    label = html('Dates of<br>consultation/hospitalisation'),
    columns = vars(date_adm_first, date_adm_last)) %>%
  tab_spanner(
    label = html('Confirmed'),
    columns = starts_with('confirmed_')) %>%
  tab_spanner(
    label = html('Probable'),
    columns = starts_with('probable_')) %>%
  tab_spanner(
    label = html('Suspected'),
    columns = starts_with('suspected_')) %>%
  tab_spanner(
    label = html('Not a case'),
    columns = starts_with('not_case_')) %>% 
  tab_spanner(
    label = html('Not a suspect'),
    columns = starts_with('not_suspect_')) %>%
  tab_spanner(
    label = html('(Unknown)'),
    columns = starts_with('unknown_')) %>%
  fmt_number(
    columns = ends_with('_p'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = starts_with('date_adm_'),
    missing_text = "Unknown") %>%
  cols_align(
    align = 'right',
    columns = vars(total)) %>%
  cols_align(
    align = 'left',
    columns = ends_with('_p')) %>%
  cols_align(
    align = 'center',
    columns = starts_with('date_adm_')) %>%
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(columns = ends_with('_p'))) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")),
    locations = cells_body(
      rows = site_name == 'Total')) %>% 
  tab_source_note(
    source_note = "(*) These data were reported as aggregated only and are not included in further analysis below") %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(1))

gtsave(gtbl_site_covid_status,
       file.path(path.local.country.week.tables, paste0('gtbl_site_covid_status', '_', name_country, "_", week_report, '.png'))) %>%
  invisible()


gtbl_site_covid_status

```


### Number of patients consulted or admitted in MSF Covid-19 facilities and their the evolution over time

<!-- Figure 2 - Weekly evolution of patient intake by covid status in country projects -->
```{r}
# By Paul
df_status_long <- dta_msf_combined %>% 
  select(-Total) %>% 
  pivot_longer(cols = Confirmed:Unknown, names_to = "MSF_covid_status") %>% 
  uncount(value)

missing_consultation <- sum(is.na(df_status_long$date))
missing_status    <- sum(df_status_long$MSF_covid_status == "Unknown")

# Histograms of number of patients consulted/admitted weekly in MSF facilities, filtered on OC/country/project, displayed by date of consultation and broken down by covid status
hist_epicurve_status <- df_status_long %>% 
  plot_epicurve(
    date_col = date, 
    group_col = MSF_covid_status,
    floor_date_week = FALSE, 
    sec_date_axis = TRUE,
    date_lab = "Week of Consultation", 
    y_lab = "Patients",
    group_lab = "Status"
  ) +
  labs(caption = glue::glue("Missing data: Consultation Date {missing_consultation}"))

ggsave(file.path(path.local.country.week.graphs, paste0('hist_epicurve_status', '_', name_country, "_", week_report, '.png')),

       plot = hist_epicurve_status, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

hist_epicurve_status
```

<!-- Figure 3 - Weekly evolution of patient intake by covid status in each of the country projects -->
```{r}
# By Paul 

# Multifacet Histograms of number of patients consulted/admitted weekly for each MSF facility, filtered on OC/country/project, displayed by date of consultation and broken down by covid status]



facet_dims <- get_facet_dims(dta_msf_combined)

hist_epicurve_status_site <- df_status_long %>% 
  plot_epicurve(
    date_col = date, 
    group_col = MSF_covid_status,
    facet_col = site_name,
    facet_nrow = facet_dims$nrow,
    facet_ncol = facet_dims$ncol,
    facet_scales = "free_y",
    floor_date_week = FALSE, 
    sec_date_axis = TRUE,
    date_lab = "Week of Consultation", 
    y_lab = "Patients",
    group_lab = "Status"
  ) +
  labs(caption = glue::glue("Note free y scales | Missing data: Consultation Date {missing_consultation}"))


ggsave(file.path(path.local.country.week.graphs, paste0('hist_epicurve_status_site', '_', name_country, "_", week_report, '.png')),
       plot = hist_epicurve_status_site, 
       width = 6, 
       height = facet_dims$height, 
       scale = 1.1,
       dpi = 320)


hist_epicurve_status_site
```


### Origin of patients

Origin of the patients are displayed in the map below (figure 3). 

<!-- Figure 4 – Mapping of patient origin within the country -->
```{r}
#Priority +
# by Paul

#[Country map of cases consulted/admitted in MSF facilities, filtered by OC/country/project, displaying cases according to administrative levels 1 (often region/province), 2 or 3 (lower administrative levels according to local releva
```




### Major cares procedures in MSF facilities

<!-- Table 3 – Overall proportions of cases in the different MSF projects -->
```{r table-consultation-admission}
# Priority +++
# By Francesco

#Tables of overall proportion of cases admitted or consulted, by covid status and by project

tbl_consultation_admission <- dta_msf_linelist %>% 
  prepare_msf_dta() %>% 
  mutate(
    admit = factor(merge_admit, levels = c('Yes', 'No', 'Unknown'), labels = c('admitted', 'non_admitted', 'unknown'))) %>% 
  group_by(site_name, covid_status) %>% 
  count(admit) %>% 
  pivot_wider(names_from = admit, values_from = n,  values_fill = 0, names_sort = TRUE) %>% 
  adorn_totals(c("col")) %>% 
  mutate(
    admitted_p = admitted / Total, 
    non_admitted_p = non_admitted / Total) %>%
  ungroup()

gtbl_consultation_admission <- tbl_consultation_admission %>% 
  gt(rowname_col = 'covid_status', 
     groupname_col = 'site_name') %>% 
  cols_label(
    admitted     = 'n', 
    non_admitted = 'n', 
    Total = 'Total', 
    admitted_p     = '(%)', 
    non_admitted_p = '(%)') %>% 
  tab_spanner(
    label = 'Admitted', 
    columns = starts_with('admitted')) %>% 
  tab_spanner(
    label = 'Non admitted', 
    columns = starts_with('non_admitted')) %>% 
  fmt_number(
    columns = ends_with('_p'), 
    decimals = 1, 
    scale_by = 100, 
    pattern = '({x})') %>% 
    summary_rows(
  groups = TRUE,
    columns = vars(admitted, non_admitted, Total),
    fns = list('Site Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  grand_summary_rows(
    columns = vars(admitted, non_admitted, Total),
    fns = list('Grand Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
    tab_options(
  column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    grand_summary_row.text_transform = 'uppercase',
    data_row.padding = px(1),
    row_group.padding = px(1),
    summary_row.padding = px(1),
    grand_summary_row.padding = px(1))
  

gtsave(gtbl_consultation_admission,
       file.path(path.local.country.week.tables, paste0('gtbl_consultation_admission', '_', name_country, "_", week_report, '.png'))) %>%
  invisible()


gtbl_consultation_admission


```


<!-- Figure 5 – Weekly evolution of patient intake in projects by consultation/admission status and proportion of admitted -->
```{r}
# Priority +++
# by Paul

# Histogram of number of consultation/admissions aggregated by week, broken down by admission status (consultation or admission), + curve displaying proportion of admitted, filtered by OC/ country/ project

missing_consultation <- sum(is.na(dta_msf_linelist$epi_week_consultation))
missing_admission    <- sum(dta_msf_linelist$patcourse_admit == "Unknown")

df_consult_admit <- dta_msf_linelist %>% 
  filter(patcourse_admit != "Unknown") %>% 
  mutate(patcourse_admit = recode(patcourse_admit, "Yes" = "Admitted", "No" = "Not Admitted"))

# Histograms of number of patients consulted/admitted weekly in MSF facilities, filtered on OC/country/project, displayed by date of consultation and broken down by covid status
hist_epicurve_consult_admit <- df_consult_admit %>% 
  plot_epicurve(
    date_col = epi_week_consultation, 
    group_col = patcourse_admit,
    prop_col = patcourse_admit,
    prop_numer = "Admitted",
    prop_denom = c("Admitted", "Not Admitted"),
    floor_date_week = FALSE, 
    sec_date_axis = TRUE,
    date_lab = "Week of Consultation", 
    y_lab = "Patients",
    group_lab = "Consultation",
    prop_lab = "Admitted"
  ) +
  labs(caption = glue::glue("Missing data: Consultation Date {missing_consultation}, Admission: {missing_admission}"))

ggsave(file.path(path.local.country.week.graphs, paste0('hist_epicurve_consult_admit', '_', name_country, "_", week_report, '.png')),
       plot = hist_epicurve_consult_admit, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

hist_epicurve_consult_admit
```

<!-- Figure 6 - Weekly evolution of patient intake by covid status in each of the country projects -->
```{r fig.height=6}
# Priority +++
# by Paul

#Multifacet Histogram of number of consultation/admissions aggregated by week for each MSF project, broken down by admission status (consultation or admission), + curve displaying proportion of admitted

facet_dims <- get_facet_dims(df_consult_admit)

hist_epicurve_consult_admit_site <- df_consult_admit %>% 
  plot_epicurve(
    date_col = epi_week_consultation, 
    group_col = patcourse_admit,
    prop_col = patcourse_admit,
    prop_numer = "Admitted",
    prop_denom = c("Admitted", "Not Admitted"),
    facet_col = site_name,
    facet_nrow = facet_dims$nrow,
    facet_ncol = facet_dims$ncol,
    floor_date_week = FALSE, 
    sec_date_axis = TRUE,
    date_lab = "Week of Consultation", 
    y_lab = "Patients",
    group_lab = "Consultation",
    prop_lab = "Admitted"
  ) +
  labs(caption = glue::glue("Missing data: Consultation Date {missing_consultation}, Admission: {missing_admission}"))

ggsave(file.path(path.local.country.week.graphs, paste0('hist_epicurve_consult_admit_site', '_', name_country, "_", week_report, '.png')),
       plot = hist_epicurve_consult_admit_site, 
       width = 6, 
       height = facet_dims$height, 
       scale = 1.1,
       dpi = 320)


hist_epicurve_consult_admit_site
```


### Covid-19 tests

<!-- Figure 7 – Weekly evolution of number of tests, by test result and proportion of patients tested -->
```{r}
# Priority +
# by Paul

#Histogram of overall number of tests aggregated by week, broken down by test result, + curve displaying proportion of tested, filtered by OC/country/project
```


## Characteristics of patients consulted/admitted in MSF Covid-19 facilities 
<!-- including non-cases -->

<!-- Table 4 – Age and sex distribution by covid status in MSF projects -->
```{r table-general-characteristics, layout = "l-page"}
# Priority +++
# by Francesco

# Table displaying age (median, IQR, min-max) and sex distribution, by Covid19 status, filtered by project


tbl_general_characteristics_by_status <- dta_msf_linelist %>% 
  prepare_msf_dta() %>% 
  select(covid_status, age_in_years, age_5gp, sex, Comcond_present) %>%
  group_by(covid_status) %>%
  summarise(
    age_total   = paste0(sum(!is.na(age_in_years)) , '/',  n()),  
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)),
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1),
    age_gp1     = freq_prct(age_5gp, '0-4'),
    age_gp2     = freq_prct(age_5gp, '5-14'),
    age_gp3     = freq_prct(age_5gp, '15-44'),
    age_gp4     = freq_prct(age_5gp, '45-64'),
    age_gp5     = freq_prct(age_5gp, '65+'),
    sex_total   = paste0(sum(!is.na(sex)) , '/',  n()),
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE),
    sex_ratio   = format(round(sum(sex == 'M', na.rm = TRUE)/sum(sex == 'F', na.rm = TRUE), digits = 1), nsmall = 1),
    comorbidity_total = paste0(sum(!is.na(Comcond_present)) , '/',  n()),
    comorbidity_presence = freq_prct(Comcond_present, 1))


tbl_general_characteristics_total <- dta_msf_linelist %>% 
  prepare_msf_dta() %>% 
  select(covid_status, age_in_years, age_5gp, sex, Comcond_present) %>%
  summarise(
    age_total   = paste0(sum(!is.na(age_in_years)) , '/',  n()),  
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)),
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1),
    age_gp1     = freq_prct(age_5gp, '0-4'),
    age_gp2     = freq_prct(age_5gp, '5-14'),
    age_gp3     = freq_prct(age_5gp, '15-44'),
    age_gp4     = freq_prct(age_5gp, '45-64'),
    age_gp5     = freq_prct(age_5gp, '65+'),
    sex_total   = paste0(sum(!is.na(sex)) , '/',  n()),
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE),
    sex_ratio   = format(round(sum(sex == 'M', na.rm = TRUE)/sum(sex == 'F', na.rm = TRUE), digits = 1), nsmall = 1),
    comorbidity_total = paste0(sum(!is.na(Comcond_present)) , '/',  n()),
    comorbidity_presence = freq_prct(Comcond_present, 1)) %>% 
  mutate(
    covid_status = 'Total')


tbl_general_characteristics <- tbl_general_characteristics_by_status %>% 
  add_row(tbl_general_characteristics_total) %>% 
  mutate(
    covid_status = factor(covid_status, levels = c('Confirmed', 'Probable', 'Suspected', 'Not a case', 'Not a suspect', 'Unknown', 'Total')))

vars_age <- tibble(levels = tbl_general_characteristics %>% select(starts_with('age_')) %>% names(),
                   labels = c('Totals with age information, n/N', 'Minimum - maximum', 'Median', '0 - 5, n (%)', '5 - 15, n (%)', '15 - 45, n (%)', '45 - 65, n (%)', '65+, n (%)'))

vars_sex <- tibble(levels = tbl_general_characteristics %>% select(starts_with('sex_')) %>% names(),
                   labels = c('Totals with sex information, n/N', 'Men, n', 'Women, n', 'Sex ratio (M/F)'))

vars_comorbidities <- tibble(levels = tbl_general_characteristics %>% select(starts_with('comorbidity_')) %>% names(),
                             labels = c('Totals with comorbidity information, n/N', 'Presence of at least one comorbidity, n (%)'))

gtbl_general_characteristics <- tbl_general_characteristics %>%
  gather(characteristics, values, -covid_status, factor_key = TRUE) %>%
  spread(covid_status, values) %>%
  mutate(type_characteristic = case_when(
    characteristics ==  'total' ~ NA_character_,
    characteristics %in% vars_age$levels ~ 'Age (in years)',
    characteristics %in% vars_sex$levels ~ 'Sex',
    characteristics %in% vars_comorbidities$levels ~ 'Comorbidities')) %>%
  mutate(
    characteristics = factor(characteristics,
                             levels = c(vars_age$levels, vars_sex$levels, vars_comorbidities$levels),
                             labels = c(vars_age$labels, vars_sex$labels, vars_comorbidities$labels))) %>%
  gt(rowname_col = "characteristics",
     groupname_col = "type_characteristic") %>%
  cols_label(
    characteristics = 'Characteristics') %>%
  cols_align(
    align = 'left',
    columns = vars(characteristics)) %>%
  cols_align(
    align = 'center',
    columns = vars(Confirmed, Probable, Suspected, `Not a case`, `Not a suspect`, `Unknown`)) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_general_characteristics,
       file.path(path.local.country.week.tables, paste0('gtbl_general_characteristics','_', name_country, "_", week_report, '.png'))) %>%
  invisible()



gtbl_general_characteristics

```


```{r table-general-characteristics-by-site, layout="l-body-outset"}

# Priority +++
# by Francesco

# Table displaying age (median, IQR, min-max) and sex distribution, by Covid19 status, filtered by project

tbl_general_characteristics_by_site <- dta_msf_linelist %>% 
  prepare_msf_dta() %>% 
  select(site_name, age_in_years, age_5gp, sex, Comcond_present) %>%
  group_by(site_name) %>%
  summarise(
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1), 
    age_iqr     = paste0('(', quantile(age_in_years, 0.25, na.rm = TRUE), ' - ', quantile(age_in_years, 0.75, na.rm = TRUE), ')'), 
    age_min_max = paste0('[', min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE), ']'), 
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE),
    sex_ratio   = format(round(sum(sex == 'M', na.rm = TRUE)/sum(sex == 'F', na.rm = TRUE), digits = 1), nsmall = 1))

gtbl_general_characteristics_by_site <- tbl_general_characteristics_by_site %>% 
  gt() %>% 
  cols_label(
    site_name = 'Site/Project', 
    age_median = 'median', 
    age_iqr = '(25-75% IQR)', 
    age_min_max = '[min-max]', 
    sex_males = 'Males', 
    sex_females = 'Females', 
    sex_ratio = 'M/F ratio') %>% 
  tab_spanner(
    label = 'Age', 
    columns = starts_with('age')) %>% 
  tab_spanner(
    label = 'Sex', 
    columns = starts_with('sex')) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))


gtsave(gtbl_general_characteristics_by_site,
       file.path(path.local.country.week.tables, paste0('gtbl_general_characteristics_by_site','_', name_country, "_", week_report, '.png'))) %>%
  invisible()



gtbl_general_characteristics_by_site

```



<!-- Figure 8 – Frequency and proportion of symptoms in covid19 patients presenting in MSF facilities, by covid19 status -->
```{r}
# Priority ++
# by Paul

sympt_lvl <-  c(
  "None" = "patcourse_asymp",
  "Fever/Chills" = "MSF_symptom_fever_chills",
  "Cough" = "MSF_symptom_cough",
  "Breathlessness" = "MSF_symptom_breathlessness",
  "Sore throat" = "MSF_symptom_sorethoat" ,
  "Headache" = "MSF_symptom_headache",
  "Abdominal pain" = "MSF_symptom_abdominal_pain",
  "Tiredness" = "MSF_symptom_tiredness",
  "Aches" = "MSF_symptom_aches",
  "Nose congestion" = "MSF_symptom_nose_congestion",
  "Runny nose" = "MSF_symptom_runny_nose",
  "Diarrhoea" = "MSF_symptom_diarrhoea",
  "Vomitting" = "MSF_symptom_vomiting",
  "Loss of taste" = "MSF_symptom_loss_taste",
  "Loss of smell" = "MSF_symptom_anosmia",
  "Chest pain" = "MSF_symptom_chest_pain"
)

df_symptoms <- dta_msf_linelist %>% 
  select(starts_with("MSF_Symptom"), patcourse_asymp) %>% 
  select(-ends_with("_date_onset")) %>% 
  tidyr::pivot_longer(everything(), names_to = "symptom", values_to = "yes_no") %>% 
  mutate(symptom = recode(symptom, MSF_symptom_chills = "MSF_symptom_fever_chills", MSF_symptom_fever = "MSF_symptom_fever_chills")) %>% 
  group_by(symptom) %>% 
  summarise(total = sum(!is.na(yes_no)),
            yes = sum(yes_no == "Yes", na.rm = T),
            prop = (yes / total)) %>% 
  ungroup() %>% 
  filter(yes > 0) %>% 
  mutate(symptom = factor(symptom, levels = sympt_lvl, labels = names(sympt_lvl))) %>% 
  arrange(-prop)


plot_symptoms <- ggplot(df_symptoms, aes(fct_reorder(symptom, prop), prop)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(
    label = glue::glue("{yes} / {total}"), 
    y = prop, 
    colour = ifelse(prop < max(prop) / 4, "grey30", "white"),
    hjust = ifelse(prop < max(prop) / 4, -0.1, 1.1)
  ), 
  size = 3, fontface = "bold") + #hjust = -.02,
  scale_colour_identity() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = expansion(mult = c(0, 0.1))) +
  coord_flip() +
  labs(y = "Proportion", x = NULL)

ggsave(file.path(path.local.country.week.graphs, paste0('plot_symptoms', '_', name_country, "_", week_report, '.png')),
       plot = plot_symptoms,
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

plot_symptoms
```


<!-- Figure 9 – Frequency and proportion of morbidities in non-case covid-19 patients -->
```{r}
# by Paul

# Histogram? (I think it is better a table) with frequency and proportion of recorded diagnosis, filtered by OC /country/ project
```


<!-- Figure 10 – Case Fatality Risk by covid status and project -->
```{r}
# Priority +++
# by Francesco

# Case Fatality Risk by covid status and project, filtered by project

dta <- dta_msf_linelist %>% 
  prepare_msf_dta()

tbl_cfr_site <- dta %>%
  select(site_name, outcome_status) %>%
  filter(outcome_status %in% c('Cured', 'Died')) %>%
  group_by(site_name) %>%
  summarise(
    totals_Total = paste0(sum(outcome_status == 'Died'), '/', n()),
    died_p_Total = mean(outcome_status == 'Died')) %>% 
  ungroup()

tbl_cfr_status_site <- dta %>% 
  select(site_name, covid_status, outcome_status) %>%
  filter(outcome_status %in% c('Cured', 'Died')) %>%
  group_by(site_name, covid_status) %>%
  summarise(
    totals = paste0(sum(outcome_status == 'Died'), '/', n()),
    died_p = mean(outcome_status == 'Died')) %>% 
  ungroup() %>% 
  pivot_wider(names_from = covid_status, values_from = c(totals, died_p))

gtbl_cfr_status_site <- tbl_cfr_status_site %>%
  full_join(tbl_cfr_site) %>% 
  select(site_name, totals_Confirmed, totals_Suspected, `totals_Not a case`, died_p_Confirmed, died_p_Suspected, `died_p_Not a case`, totals_Total, died_p_Total) %>% 
  gt() %>%
  cols_label(
    site_name           = 'Site/project', 
    totals_Confirmed    = 'n/N', 
    totals_Suspected    = 'n/N',
    `totals_Not a case` = 'n/N', 
    totals_Total        = 'n/N',
    died_p_Confirmed    = '(%)',
    died_p_Suspected    = '(%)',
    `died_p_Not a case` = '(%)', 
    died_p_Total        = '(%)') %>%
  tab_spanner(
    label = 'Confirmed',
    columns = ends_with('Confirmed')) %>%
  tab_spanner(
    label = 'Suspected',
    columns = ends_with('Suspected')) %>%
  tab_spanner(
    label = 'Not a case',
    columns = ends_with('Not a case')) %>% 
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>%
  fmt_number(
    columns = starts_with('died_p_'),
    decimals = 1,
    scale_by = 100,
    pattern = '({x})') %>%
  fmt_missing(
    columns = starts_with('totals_'),
    missing_text = "0/0") %>%
  fmt_missing(
    columns = starts_with('died_p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(site_name)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('totals')) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_cfr_status_site,
       file.path(path.local.country.week.tables, paste0('gtbl_cfr_status_site','_', name_country, "_", week_report, '.png'))) %>%
  invisible()


gtbl_cfr_status_site

```


## Description of Covid19 [confirmed/probable/suspect] patients

### Age/Sex pyramid

<!-- Figure 11 – Age and sex pyramid of [confirmed/probable/suspect] patients in MSF facilities -->
```{r}
# by Paul

# Age/sex pyramid of patients, filtered by OC /country/ project

m_age_sex <- dta_msf_linelist %>% 
  filter(MSF_covid_status %in% include_status) %>% 
  summarise(age = sum(age_in_years == "Unknown"), sex = sum(patinfo_sex == "Unknown"))

asp_caption <- ifelse(sum(m_age_sex$age, m_age_sex$sex) > 0, glue::glue("Missing Data: Age {m_age_sex$age}, Sex {m_age_sex$sex}"), NULL)

tbl_pyramid_confirmed <- dta_msf_linelist %>% 
  filter(age_in_years != "Unknown", patinfo_sex != "Unknown") %>% 
  filter(MSF_covid_status %in% include_status) %>% 
  count(patinfo_sex, age_group) %>% 
  mutate(n = if_else(patinfo_sex == "M", -n, n))

pyramid_age_sex_confirmed <- ggplot(tbl_pyramid_confirmed, aes(x = age_group, y = n, fill = patinfo_sex)) +
  geom_col() +
  geom_hline(yintercept = 0, colour = "black") +
  geom_text(aes(label = abs(n), hjust = pyramid_labs_pos(n), colour = pyramid_labs_colour(n)), size = 4) + 
  coord_flip() +
  scale_colour_identity() +
  scale_fill_manual(name = NULL, values = c("#4E79A7FF", "#A0CBE8FF"), breaks = c("M", "F"), labels = c("Males", "Females")) +
  scale_y_continuous(limits = pyramid_limits, breaks = pyramid_brks, label = abs) + 
  theme(legend.position = "top") +
  labs(x = "Age Group", y = "Patients", caption = asp_caption)  +
  guides(y.sec = guide_axis_label_trans(~paste(.x))) # show age group labels on both axis

ggsave(file.path(path.local.country.week.graphs, paste0('pyramid_age_sex_confirmed', '_', name_country, "_", week_report, '.png')),
       plot = pyramid_age_sex_confirmed,
       width = 8,
       height = 6)

pyramid_age_sex_confirmed
```

### Age/Sex pyramid by site

<!-- Figure 12 – Age and sex pyramid of [confirmed/probable/suspect] patients in each of the MSF facilities -->
```{r fig.height=6}
# by Paul

# [Multifacet Age/sex pyramid of patients for each project, filtered by OC /country/ project]

tbl_pyramid_confirmed_site <- dta_msf_linelist %>% 
  drop_na(patinfo_sex, age_group) %>% 
  filter(MSF_covid_status %in% include_status, patinfo_sex != "Unknown", age_group != "Unknown") %>% 
  count(site_name, patinfo_sex, age_group) %>% 
  mutate(n = if_else(patinfo_sex == "M", -n, n))

facet_dims <- get_facet_dims(tbl_pyramid_confirmed_site)

pyramid_age_sex_confirmed_site <- ggplot(tbl_pyramid_confirmed_site, aes(x = age_group, y = n, fill = patinfo_sex)) +
  facet_wrap(~site_name, ncol = facet_dims$ncol, nrow = facet_dims$nrow, scales = "free_x", labeller = label_wrap_gen()) +
  geom_col() +
  geom_hline(yintercept = 0, colour = "black") +
  #geom_text(aes(label = abs(n), hjust = pyramid_labs_pos(n), colour = pyramid_labs_colour(n)), size = 4) +
  #scale_colour_identity() +
  coord_flip() +
  scale_fill_manual(name = NULL, values = c("#4E79A7FF", "#A0CBE8FF"), breaks = c("M", "F"), labels = c("Males", "Females")) +
  scale_y_continuous(label = abs, limits = pyramid_limits) + 
  theme(legend.position = "top") +
  labs(x = "Age Group", y = "Patients", caption = paste0("Note free x scales | ", asp_caption))

ggsave(file.path(path.local.country.week.graphs, paste0('pyramid_age_sex_confirmed_site', '_', name_country, "_", week_report, '.png')),
       plot = pyramid_age_sex_confirmed_site,
       width = 6,
       height = facet_dims$height)


pyramid_age_sex_confirmed_site
```


### Type of exposure to the  Covid-19 infection

Overall, X patients recorded a type of exposure among patients received in MSF facilities.

<!-- Figure 13 – Different exposures recorded among [confirmed/probable/suspect] patients in MSF facilities -->
```{r}
# Priority +
# by Paul

# [Graph displaying number and proportion of different types of exposure of [confirmed/probable/suspect]cases (working in healthcare facility, visiting a healthcare facility, through contact with confirmed case, in a different country), filtered by OC /country/ project]
```


### Underlying conditions
<!-- Frequency and proportions of the number of comorbidities recorded among [confirmed/probable/suspect] patients in MSF facilities -->
```{r}
# Priority +++
# by Francesco

#[Table of frequency and proportions of [confirmed/probable/suspect] cases cases with 0, 1, 2, 3 or more comorbidities, filtered by OC /country/ project]
```


<!-- Frequency and proportions of each recorded comorbidities among [confirmed/probable/suspect] patients in MSF facilities -->
```{r}
# by Francesco

# [Table displaying the frequency and proportion of cases with each recorded comorbidities, by projects, filtered by OC /country/ project]

```



### Level of care received

<!-- Number and proportions of the different level of care in admitted [confirmed/probable/suspect] patients in MSF facilities
To be completed as appropriate -->
```{r}
# by Paul

# [Graph displaying number and proportions of [confirmed/probable/suspect] patient who were admitted, received oxygen, admitted to ICU, or supported by ventilator or ECMO, aggregated by week, by project location, filtered by OC /country/ project]
```


<!-- Proportion of [confirmed/probable/suspect] patients having received oxygen therapy in MSF facilities according to age and reporting comorbidity or not -->
```{r}
# by Paul

# [Graph displaying the proportion of cases receiving O2 according to age (continuous) and reporting comorbidity or not, filtered by OC /country/ project]
# Not sure the graph is a better option
```


### Patients' outcomes

<!-- Frequency and proportions of each recorded outcome in [confirmed/probable/suspect] patients in MSF facilities, by age groups -->
```{r}
# Priority +++
# by Francesco

# [Table displaying frequency and proportions of each recorded outcome, by age groups, filtered by OC /country/ project]
```

<!-- Case fatality risk in [confirmed/probable/suspect] patients in MSF facilities, by age groups, sex and by project -->
```{r}
# Priority +++
# by Francesco

# [Table displaying the Case Fatality Risk, by age groups, sex and by project, filtered by OC /country/ project]
 
```


<!-- Case fatality risk in the different age groups among [confirmed/probable/suspect] patients in MSF facilities -->
```{r, eval=FALSE}
# by Paul

#[Graph displaying the Case Fatality Risk, by age groups, with respective confidence intervals (died and recovered patients), filtered by OC /country/ project]


# !!! @Paul we need to use merge_admit (created by prepare_msf_dta) instead of patcourse_admit or outcome_patcourse_admit
# Note that I put eval = FALSE because knit got stuck in this chunck

df_severity <- dta_msf_linelist %>% 
  filter(age_group != "Unknown", 
         MSF_covid_status %in% include_status) %>% 
  group_by(age_group) %>% 
  summarize(
    n = n(),
    n_hosp = sum(patcourse_admit == "Yes", na.rm = TRUE),
    n_hosp_known = sum(patcourse_admit %in% c("Yes", "No"), na.rm = TRUE),
    p_hosp = n_hosp / n_hosp_known,
    hosp_lab = paste0("(", n_hosp, "/", n_hosp_known, ")"),
    n_died = sum(outcome_patcourse_status == "Died", na.rm = TRUE),
    n_died_known = sum(outcome_patcourse_status %in% c("Died", "Cured"), na.rm = TRUE),
    p_died = n_died / n_died_known,
    hosp_lab = paste0("(", n_hosp_known, ")"),
    died_lab = paste0("(", n_died_known, ")"),
    died_lab = paste0("(", n_died, "/", n_died_known, ")")
  ) %>% 
  filter(n_died_known > 0) %>% 
  group_by(age_group) %>% 
  mutate(
    p_hosp_low95 = as.numeric(binom.test(n_hosp, n_hosp_known)$conf.int)[1],
    p_hosp_upp95 = as.numeric(binom.test(n_hosp, n_hosp_known)$conf.int)[2],
    p_died_low95 = as.numeric(binom.test(n_died, n_died_known)$conf.int)[1],
    p_died_upp95 = as.numeric(binom.test(n_died, n_died_known)$conf.int)[2]
  ) %>% 
  ungroup()

dots_cfr_agegroup <- ggplot(df_severity, aes(x = age_group)) +
  geom_point(aes(y = p_died), size = 2) +
  geom_linerange(aes(ymin = p_died_low95, ymax = p_died_upp95)) +
  geom_text(aes(label = died_lab, y = p_died_upp95), size = 4.2, vjust = -1) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), #expand = expansion(mult = c(0.05, 0.1)),
                     labels = scales::percent_format(accuracy = 1), sec.axis = dup_axis(name = NULL)) +  
  labs(x = "Age Group", y = "CFR", caption = "CFR = deaths / known outcomes (cured + died)\nLine range shows binomial 95% confidence intervals") 

ggsave(file.path(path.local.country.week.graphs, paste0('dots_cfr_agegroup', '_', name_country, "_", week_report, '.png')),
       plot = dots_cfr_agegroup,
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)


dots_cfr_agegroup
```



### Other operational indicators

#### Delay from symptoms to consultation/admission

The overall delay from symptoms to consultation/admission in MSF facilities was of X days. 

<!-- Weekly distribution of delay from symptoms to consultation/admission of covid19 patients in MSF facilities -->
```{r}
# Priority +++
# by Paul

#[Box plot displaying distribution of delay from symptoms onset to consultation/admission, aggregated by week, with trend and filtered by OC /country/ project]

dta_delay <- dta_msf_linelist %>%
  #filter(MSF_covid_status %in% include_status) %>% # Is status important for this metric?
  drop_na(epi_week_consultation, MSF_delay_before_admission) %>%
  filter(MSF_delay_before_admission >= 0, MSF_delay_before_admission <= 50) # filter any delays over 50 days
  
boxplot_delay_admission_week <- ggplot(dta_delay, aes(epi_week_consultation, MSF_delay_before_admission, group = epi_week_consultation)) +
  geom_boxplot() +
  scale_x_date(
    name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V", 
    sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))
    ) +
  labs(y = "Onset to admission delay (days)")

ggsave(file.path(path.local.country.week.graphs, paste0('boxplot_delay_admission_week', '_', name_country, "_", week_report, '.png')),
       plot = boxplot_delay_admission_week, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)


boxplot_delay_admission_week

```

<!-- Weekly distribution of delay from symptoms to consultation/admission of covid19 patients in each of the MSF facilities -->
```{r}
# Priority ++
# by Paul

# [Multifacet Box plot displaying distribution of delay from symptoms onset to consultation/admission, aggregated by week, with trend and filtered by OC /country/ project]

facet_dims <- get_facet_dims(dta_delay)

boxplot_delay_admission_week_site <- ggplot(dta_delay, aes(epi_week_consultation, MSF_delay_before_admission, group = epi_week_consultation)) +
  facet_wrap(~site_name, labeller = label_wrap_gen(25), ncol = facet_dims$ncol, nrow = facet_dims$nrow) +
  geom_boxplot() +
  scale_x_date(
    name = "Week of Consultation", date_breaks = "1 week", date_labels = "%V", 
    sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))
    ) +
  labs(y = "Onset to admission delay (days)")

ggsave(file.path(path.local.country.week.graphs, paste0('boxplot_delay_admission_week_site', '_', name_country, "_", week_report, '.png')),
       plot = boxplot_delay_admission_week_site, 
       width = 6, 
       height = facet_dims$height, 
       scale = 1.1,
       dpi = 320)


boxplot_delay_admission_week_site
```


#### Length of stay

The overall length of stay in MSF facilities was of X days. 

<!--  Weekly distribution of length of stay of covid19 patients in MSF facilities -->
```{r}
# Priority +++
# by Paul

#[Box plot displaying distribution of length of stay for hospitalized patients (all hospitalized and admitted in ICU), aggregated by week, with trend and filtered by OC /country/ project. The last 2 weeks will be excluded due to uncomplete data]

# 2 most recent epi weeks to remove from chart
latest_2_epiweeks <- max_2(dta_msf_linelist$epi_week_consultation)

# length stay
tbl_length_stay <- dta_msf_linelist %>% 
  #filter(MSF_covid_status %in% include_status) %>% # I guess status is not important for this metric?
  filter(patcourse_admit == 'Yes') %>% 
  drop_na(epi_week_consultation, MSF_length_stay) %>% 
  filter(MSF_length_stay <= 50, !epi_week_consultation %in% latest_2_epiweeks) # filter any stays over 50 days


boxplot_length_stay_week <- ggplot(tbl_length_stay, aes(epi_week_consultation, MSF_length_stay, group = epi_week_consultation)) + 
  geom_boxplot() + 
  scale_x_date(
    name = "Week of Admission", date_breaks = "1 week", date_labels = "%V", 
    sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))
  ) +
  labs(y = "Length of stay in hospital (days)", caption = "Latest 2 weeks omitted for data completeness purposes")

ggsave(file.path(path.local.country.week.graphs, paste0('boxplot_length_stay_week', '_', name_country, "_", week_report, '.png')),
       plot = boxplot_length_stay_week, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

boxplot_length_stay_week
```

<!-- Weekly distribution of length of stay of covid19 patients in each of the MSF facilities
To be completed as appropriate -->
```{r}
# Priority ++
# by Paul

#[Multifacet Box plot displaying distribution of length of stay, aggregated by week, with trend and filtered by OC /country/ project]

facet_dims <- get_facet_dims(tbl_length_stay)

boxplot_length_stay_week_site <- ggplot(tbl_length_stay, aes(epi_week_consultation, MSF_length_stay, group = epi_week_consultation)) + 
  facet_wrap(~site_name, labeller = label_wrap_gen(25), ncol = facet_dims$ncol, nrow = facet_dims$nrow) +
  geom_boxplot() +  
  scale_x_date(
    name = "Week of Admission", date_breaks = "1 week", date_labels = "%V", 
    sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))
  ) +
  labs(y = "Length of stay in hospital (days)", caption = "Latest 2 weeks omitted for data completeness purposes")

ggsave(file.path(path.local.country.week.graphs, paste0('boxplot_length_stay_week_site', '_', name_country, "_", week_report, '.png')),
       plot = boxplot_length_stay_week_site, 
       width = 6, 
       height = facet_dims$height, 
       scale = 1.1,
       dpi = 320)

boxplot_length_stay_week_site
```


### Bed occupancy rates

<!-- Bed occupancy rates in the projects reporting, in MSF facilities -->

```{r}
# Priority +
# by Francesco

# [Table displaying bed occupancy rate, aggregated by week, by projects]
```



